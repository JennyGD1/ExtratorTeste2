<!DOCTYPE html>
<html lang="pt-br">
<head>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Extrator de Contracheques - Maida Health</title>
  <link rel="icon" href="{{ url_for('static', filename='img/logo_maida.png') }}" />
</head>
<body class="page-index">
  {% include '_preloader.html' %}
  <div class="logo">
    <img src="{{ url_for('static', filename='img/logo_maida.png') }}" alt="Logo da Maida Health" loading="lazy">
  </div>
  <main>
    <div class="borda-animada">
      <div class="content-box">
        <h1>Calculadora de Mensalidades</h1>
        
        <!-- Formul√°rio de Grupo Familiar -->
        <form id="familia-form" method="POST" action="/familia">
          <div class="form-group">
            <label for="tamanho-familia">Tamanho do Grupo Familiar:</label>
            <select id="tamanho-familia" name="tamanho_familia" required>
              <option value="" disabled selected>Selecione a quantidade</option>
              <option value="1">1 - Apenas titular</option>
              <option value="2">2 - Titular + 1</option>
              <option value="3">3 - Titular + 2</option>
              <option value="4">4 - Titular + 3</option>
              <option value="5">5 - Titular + 4</option>
              <option value="6">6 - Titular + 5</option>
              <option value="7">7 - Titular + 6</option>
              <option value="8">8 - Titular + 7</option>
              <option value="9">9 - Titular + 8</option>
              <option value="10">10 - Titular + 9</option>
              <option value="11">11 - Titular + 10</option>
              <option value="12">12 - Titular + 11</option>
              <option value="13">13 - Titular + 12</option>
              <option value="14">14 - Titular + 13</option>
              <option value="15">15 - Titular + 14</option>
              <option value="16">16 - Titular + 15</option>
              <option value="17">17 - Titular + 16</option>
              <option value="18">18 - Titular + 17</option>
              <option value="19">19 - Titular + 18</option>
              <option value="20">20 - Titular + 19</option>
              <option value="21">21 - Titular + 20</option>
            </select>
          </div>

          <div id="conjuge-container" class="hidden">
            <div class="form-group">
              <input type="checkbox" id="incluir-conjuge" name="incluir_conjuge">
              <label for="incluir-conjuge">Incluir c√¥njuge/companheiro(a)</label>
            </div>
          </div>

          <div id="dependentes-container" class="hidden">
            <h3>Dependentes e Agregados</h3>
            <div id="dependentes-lista"></div>
            <button type="button" id="adicionar-dependente" class="btn-secondary">+ Adicionar Dependente</button>
          </div>

          <div class="form-group">
            <button type="submit" class="process-btn">Salvar Fam√≠lia</button>
          </div>
        </form>

        <!-- Upload de Arquivos -->
        <div id="upload-container" class="hidden">
          <input type="file" id="file-upload" multiple hidden aria-label="Selecionar arquivos" />
          <label for="file-upload" class="upload-btn">üìÅ Escolher Arquivos</label>
          <p id="file-name" class="file-name" aria-live="polite">Nenhum arquivo selecionado</p>
          <button type="button" class="process-btn" aria-busy="false">Processar</button>
          <progress id="upload-progress" value="0" max="100" hidden></progress>
        </div>
      </div>
    </div>
  </main>
  <footer>
    Desenvolvido por Jennifer Lima
  </footer>

  <div class="bg-shapes">
    <svg viewBox="0 0 600 600" xmlns="http://www.w3.org/2000/svg">
      <g transform="translate(300,300)">
        <path d="M150,-164C198,-122,235,-61,230,-4.6C225,51,178,102,130,146C82,190,34,228,-20,236C-73,244,-145,221,-176,172C-207,123,-197,48,-180,-20C-163,-89,-138,-151,-94,-190C-50,-229,13,-244,75,-231C137,-218,199,-176,150,-164Z" fill="rgba(255, 255, 255, 0.05)"/>
      </g>
    </svg>
  </div>

  <div class="scrollbar-container">
    <div class="scrollbar-thumb" id="scrollThumb"></div>
  </div>

  <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elementos do DOM
      const tamanhoFamilia = document.getElementById('tamanho-familia');
      const conjugeContainer = document.getElementById('conjuge-container');
      const dependentesContainer = document.getElementById('dependentes-container');
      const uploadContainer = document.getElementById('upload-container');
      const dependentesLista = document.getElementById('dependentes-lista');
      const btnAdicionarDependente = document.getElementById('adicionar-dependente');
      const fileInput = document.getElementById('file-upload');
      const fileNameText = document.getElementById('file-name');
      const processBtn = document.querySelector('#upload-container .process-btn');
      const progressBar = document.getElementById('upload-progress');

      // Atualizar interface quando o tamanho da fam√≠lia muda
      tamanhoFamilia.addEventListener('change', function() {
        const qtd = parseInt(this.value);
        const maxDependentes = Math.max(0, qtd - 1); // Subtrai o titular
        
        if (qtd > 1) {
          conjugeContainer.classList.remove('hidden');
          dependentesContainer.classList.remove('hidden');
          uploadContainer.classList.add('hidden');
        } else {
          conjugeContainer.classList.add('hidden');
          dependentesContainer.classList.add('hidden');
          uploadContainer.classList.remove('hidden');
        }
        
        // Limpar e atualizar dependentes
        dependentesLista.innerHTML = '';
        btnAdicionarDependente.disabled = maxDependentes === 0;
      });

      // Adicionar novo dependente
      btnAdicionarDependente.addEventListener('click', function() {
        const qtd = parseInt(tamanhoFamilia.value);
        const maxDependentes = qtd - 1;
        const currentDependentes = document.querySelectorAll('.dependente-item').length;
        
        if (currentDependentes >= maxDependentes) {
          alert(`Voc√™ pode adicionar no m√°ximo ${maxDependentes} dependentes.`);
          return;
        }
        
        const dependenteId = Date.now();
        const dependenteHTML = `
          <div class="dependente-item" id="dependente-${dependenteId}">
            <div class="form-row">
              <div class="form-group">
                <label for="nome-${dependenteId}">Nome:</label>
                <input type="text" id="nome-${dependenteId}" name="nome_${dependenteId}" required>
              </div>
              
              <div class="form-group">
                <label for="tipo-${dependenteId}">Tipo:</label>
                <select id="tipo-${dependenteId}" name="tipo_${dependenteId}" required>
                  <option value="" disabled selected>Selecione</option>
                  <option value="filho">Filho(a)</option>
                  <option value="enteado">Enteado(a)</option>
                  <option value="neto">Neto(a)</option>
                  <option value="tutelado">Tutelado(a)</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="nascimento-${dependenteId}">Data Nascimento:</label>
                <input type="date" id="nascimento-${dependenteId}" name="nascimento_${dependenteId}" required>
              </div>
              
              <div class="form-group check-group">
                <input type="checkbox" id="risco-${dependenteId}" name="risco_${dependenteId}">
                <label for="risco-${dependenteId}">Parcela de Risco</label>
              </div>
              
              <div class="form-group check-group">
                <input type="checkbox" id="interrompido-${dependenteId}" name="interrompido_${dependenteId}" class="interrupcao-checkbox">
                <label for="interrompido-${dependenteId}">Interrup√ß√£o de Plano</label>
              </div>
              
              <div id="data-interrupcao-${dependenteId}" class="form-group hidden">
                <label for="data-exclusao-${dependenteId}">Data de Exclus√£o:</label>
                <input type="date" id="data-exclusao-${dependenteId}" name="data_exclusao_${dependenteId}">
              </div>
              
              <button type="button" class="btn-remover" data-id="${dependenteId}">√ó</button>
            </div>
          </div>
        `;
        
        dependentesLista.insertAdjacentHTML('beforeend', dependenteHTML);
        btnAdicionarDependente.disabled = currentDependentes + 1 >= maxDependentes;
        
        // Adicionar evento para mostrar/ocultar data de interrup√ß√£o
        document.getElementById(`interrompido-${dependenteId}`).addEventListener('change', function() {
          const dataInterrupcao = document.getElementById(`data-interrupcao-${dependenteId}`);
          if (this.checked) {
            dataInterrupcao.classList.remove('hidden');
          } else {
            dataInterrupcao.classList.add('hidden');
          }
        });
        
        // Adicionar evento de remo√ß√£o
        document.querySelector(`button[data-id="${dependenteId}"]`).addEventListener('click', function() {
          document.getElementById(`dependente-${this.dataset.id}`).remove();
          btnAdicionarDependente.disabled = false;
        });
      });

      // L√≥gica de upload de arquivos
      function isPDF(file) {
        return file.type === 'application/pdf';
      }

      fileInput.addEventListener('change', function() {
        if (this.files.length === 0) {
          fileNameText.textContent = 'Nenhum arquivo selecionado';
          return;
        }

        const invalidFiles = Array.from(this.files).filter(file => !isPDF(file));
        
        if (invalidFiles.length > 0) {
          fileNameText.textContent = 'Por favor, selecione apenas arquivos PDF';
          this.value = '';
          return;
        }

        fileNameText.textContent = this.files.length === 1 
          ? this.files[0].name 
          : `${this.files.length} arquivos PDF selecionados`;
      });

      processBtn.addEventListener('click', async function() {
        const files = fileInput.files;
        
        if (!files || files.length === 0) {
          fileNameText.textContent = 'Por favor, selecione pelo menos um arquivo PDF';
          return;
        }

        this.disabled = true;
        this.setAttribute('aria-busy', 'true');
        this.innerHTML = `<span class="spinner"></span>Processando...`;
        progressBar.hidden = false;
        progressBar.value = 0;
        fileNameText.textContent = 'Enviando arquivos...';

        try {
          const formData = new FormData();
          Array.from(files).forEach(file => {
            formData.append('files', file);
          });

          const response = await fetch('/upload', {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            window.location.href = "/resultados";
          } else {
            throw new Error('Erro no servidor');
          }
        } catch (error) {
          console.error('Erro:', error);
          fileNameText.textContent = 'Erro ao enviar arquivos. Tente novamente.';
        } finally {
          this.disabled = false;
          this.removeAttribute('aria-busy');
          this.innerHTML = 'Processar';
          progressBar.hidden = true;
        }
      });
    });
  </script>
</body>
</html>
